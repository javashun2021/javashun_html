<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Postmain Proxy 请求工具</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, input, select { width: 100%; margin: 5px 0; padding: 5px; }
    button { margin: 5px 0; padding: 6px 12px; }
    .history { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; }
    .history-item { cursor: pointer; padding: 5px; border-bottom: 1px solid #eee; }
    .history-item:hover { background: #f0f0f0; }
    pre { background: #f8f8f8; padding: 10px; border: 1px solid #ddd; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>Postmain Proxy 请求工具</h2>

  <label>设备唯一ID:</label>
  <input type="text" id="deviceId" placeholder="输入或生成设备ID">
  <button onclick="generateDeviceId()">生成随机ID</button>

  <label>请求 URL:</label>
  <input type="text" id="url" placeholder="https://example.com/api">

  <label>请求方法:</label>
  <select id="method">
    <option value="GET">GET</option>
    <option value="POST">POST</option>
    <option value="PUT">PUT</option>
    <option value="DELETE">DELETE</option>
  </select>

  <label>请求头 (JSON 格式):</label>
  <textarea id="headers" rows="4">{}</textarea>

  <label>请求体 (JSON 格式):</label>
  <textarea id="body" rows="4">{}</textarea>

  <button onclick="sendRequest()">发送请求</button>

  <h3>响应结果</h3>
  <pre id="response"></pre>

  <h3>历史请求</h3>
  <div class="history" id="history"></div>

<script>
  const deviceIdInput = document.getElementById('deviceId');
  const urlInput = document.getElementById('url');
  const methodSelect = document.getElementById('method');
  const headersInput = document.getElementById('headers');
  const bodyInput = document.getElementById('body');
  const responseBox = document.getElementById('response');
  const historyBox = document.getElementById('history');

  // 初始化设备ID
  window.onload = () => {
    const savedId = localStorage.getItem('deviceId');
    if (savedId) deviceIdInput.value = savedId;
    else generateDeviceId();
    loadHistory();
  };

  function generateDeviceId() {
      const info = [
      navigator.userAgent,
      navigator.language,
      screen.width,
      screen.height,
      screen.colorDepth,
      Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join("###");

    // 简单 hash
    let hash = 0;
    for (let i = 0; i < info.length; i++) {
      hash = (hash << 5) - hash + info.charCodeAt(i);
      hash |= 0;
    }
    return "dev-" + Math.abs(hash);
  }

  async function sendRequest() {
    const payload = {
      deviceId: deviceIdInput.value,
      url: urlInput.value,
      method: methodSelect.value,
      headers: JSON.parse(headersInput.value || '{}'),
      body: JSON.parse(bodyInput.value || '{}')
    };

    try {
      const res = await fetch('/pay/api/postmain/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      responseBox.textContent = text;
      loadHistory();
    } catch (err) {
      responseBox.textContent = '请求错误: ' + err;
    }
  }

  async function loadHistory() {
    const id = deviceIdInput.value;
    if (!id) return;
    try {
      const res = await fetch(`/pay/api/postmain/proxy/history?deviceId=${id}`);
      const history = await res.json();
      historyBox.innerHTML = '';
      history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.textContent = `${item.method} ${item.url} (${item.timestamp})`;
        div.onclick = () => fillRequest(item);
        historyBox.appendChild(div);
      });
    } catch (err) {
      historyBox.innerHTML = '<i>无法加载历史记录</i>';
    }
  }

  function fillRequest(item) {
    urlInput.value = item.url;
    methodSelect.value = item.method;
    headersInput.value = JSON.stringify(item.headers || {}, null, 2);
    bodyInput.value = JSON.stringify(item.body || {}, null, 2);
  }
</script>
</body>
</html>
