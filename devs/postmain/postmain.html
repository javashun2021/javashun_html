<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Postmain Proxy 请求工具</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f9;
    }

    h2 {
      margin: 0;
      padding: 15px;
      background: #2c3e50;
      color: #fff;
    }

    .container {
      display: flex;
      min-height: calc(100vh - 50px);
    }

    /* 历史请求区 */
    .history-panel {
      width: 280px;
      border-right: 2px solid #ddd;
      background: #fff;
      padding: 10px;
      overflow-y: auto;
    }

    .history-item {
      cursor: pointer;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .history-item:hover {
      background: #f0f0f0;
    }

    /* 分页控件 */
    /* 分页样式 —— 放在通用 button 规则之后 */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      gap: 10px;
      font-size: 14px;
    }

    .pagination button {
      padding: 5px 12px;
      border: 1px solid #007bff;
      background: #fff;
      color: #007bff;
      border-radius: 4px;
      cursor: pointer;
      transition: background .15s, color .15s, border-color .15s;
    }

    /* 悬停（仅在非禁用时生效） */
    .pagination button:hover:not(:disabled) {
      background: #007bff;
      color: #fff;
    }

    /* 禁用样式 —— 确保 selector 使用 class，不要用 #pagination */
    .pagination button:disabled,
    .pagination button[disabled] {
      background: #f0f0f0;
      color: #aaa;
      border-color: #ccc;
      cursor: not-allowed;
      pointer-events: none; /* 防止点击事件仍触发 */
      opacity: 0.9;
    }

    /* 可选：页码文本样式 */
    #pageInfo {
      color: #333;
      font-weight: 600;
      margin: 0 8px;
    }


    /* 请求区 */
    .main-panel {
      flex: 1;
      padding: 20px;
      background: #fff;
      border-left: 2px solid #ddd;
    }

    textarea, input, select {
      width: 100%;
      margin: 5px 0;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      margin: 5px 0;
      padding: 6px 12px;
      cursor: pointer;
      border: 1px solid #2c3e50;
      background: #34495e;
      color: #fff;
      border-radius: 4px;
    }

    button.loading {
      cursor: not-allowed;
      opacity: 0.7;
      position: relative;
    }
    button.loading::after {
      content: "";
      position: absolute;
      right: -25px;
      top: 50%;
      width: 16px;
      height: 16px;
      margin-top: -8px;
      border: 2px solid #ccc;
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    pre {
      background: #f8f8f8;
      padding: 10px;
      border: 1px solid #ddd;
      overflow-x: auto;
    }

    /* 手机端样式 */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .history-panel {
        display: none;
        position: fixed;
        top: 50px;
        left: 0;
        bottom: 0;
        width: 250px;
        background: #fff;
        border-right: 2px solid #ddd;
        z-index: 1000;
        overflow-y: auto;
      }
      .history-panel.active {
        display: block;
      }
      .toggle-history {
        display: block;
        margin: 10px;
      }
    }
    @media (min-width: 769px) {
      .toggle-history {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h2>Postmain Proxy 请求工具</h2>
  <button class="toggle-history" onclick="toggleHistory()">📜 查看历史请求</button>

  <div class="container">
    <!-- 历史请求 -->
    <div class="history-panel">
      <div id="history"></div>
      <!-- 分页控件 -->
      <div class="pagination">
        <button id="prevPage" disabled onclick="changePage(-1)">上一页</button>
        <span id="pageInfo">第 1 / 1 页</span>
        <button id="nextPage" onclick="changePage(1)">下一页</button>
      </div>
    </div>

    <!-- 请求工具 -->
    <div class="main-panel">
      <label>设备唯一ID:</label>
      <input type="text" id="deviceId" placeholder="输入或生成设备ID">
      <button onclick="generateDeviceId()">生成随机ID</button>

      <label>请求 URL:</label>
      <input type="text" id="url" placeholder="https://example.com/api">

      <label>请求方法:</label>
      <select id="method">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
      </select>

      <label>内容类型(Content-Type):</label>
      <select id="contentType" onchange="setContentType()">
        <option value="application/json">application/json</option>
        <option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option>
        <option value="text/xml">text/xml</option>
        <option value="text/plain">text/plain</option>
      </select>

      <label>请求头 (支持 JSON 或 每行 `key: value` 格式):</label>
      <textarea id="headers" rows="4">Content-Type: application/json</textarea>

      <label>请求体:</label>
      <textarea id="body" rows="4"></textarea>

      <button id="sendBtn" onclick="sendRequest()">发送请求</button>

      <h3>响应结果</h3>
      <pre id="response"></pre>
    </div>
  </div>

<script>
  const deviceIdInput = document.getElementById('deviceId');
  const urlInput = document.getElementById('url');
  const methodSelect = document.getElementById('method');
  const contentTypeSelect = document.getElementById('contentType');
  const headersInput = document.getElementById('headers');
  const bodyInput = document.getElementById('body');
  const responseBox = document.getElementById('response');
  const historyBox = document.getElementById('history');
  const sendBtn = document.getElementById('sendBtn');

  // 分页参数
  let pageNum = 1;
  const pageSize = 10;
  let total = 0;

  // 初始化设备ID
  window.onload = () => {
    const savedId = localStorage.getItem('deviceId');
    if (savedId) deviceIdInput.value = savedId;
    else generateDeviceId();
    loadHistory();
  };

  function generateDeviceId() {
    const info = [
      navigator.userAgent,
      navigator.language,
      screen.width,
      screen.height,
      screen.colorDepth,
      Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join("###");

    let hash = 0;
    for (let i = 0; i < info.length; i++) {
      hash = (hash << 5) - hash + info.charCodeAt(i);
      hash |= 0;
    }
    const devId = "dev-" + Math.abs(hash);
    deviceIdInput.value = devId;
    localStorage.setItem('deviceId', devId);
    return devId;
  }

  function parseHeaders(text) {
    let headers = {};
    try {
      headers = JSON.parse(text);
    } catch {
      const lines = text.split("\n");
      lines.forEach(line => {
        const [key, ...rest] = line.split(":");
        if (key && rest.length) {
          headers[key.trim()] = rest.join(":").trim();
        }
      });
    }
    return headers;
  }

  function setContentType() {
    let headers = parseHeaders(headersInput.value);
    headers["Content-Type"] = contentTypeSelect.value;
    headersInput.value = Object.entries(headers).map(([k, v]) => `${k}: ${v}`).join("\n");
  }

  async function sendRequest() {
    const headers = parseHeaders(headersInput.value || "");
    const payload = {
      deviceId: deviceIdInput.value,
      url: urlInput.value,
      method: methodSelect.value,
      headers,
      body: bodyInput.value
    };

    sendBtn.classList.add("loading");
    sendBtn.disabled = true;

    try {
      const res = await fetch('/pay/api/postmain/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      const data = result.data || {};
      let bodyText = data.body;
      try {
        bodyText = JSON.stringify(JSON.parse(data.body), null, 2);
      } catch {}

      responseBox.innerHTML = `
        <div>
          <p><strong>Status:</strong> ${data.statusCodeValue || '-'} (${data.statusCode || '-'})</p>
          <p><strong>Body:</strong></p>
          <pre>${bodyText || ''}</pre>
        </div>
      `;
      loadHistory();
    } catch (err) {
      responseBox.textContent = '请求错误: ' + err;
    } finally {
      sendBtn.classList.remove("loading");
      sendBtn.disabled = false;
    }
  }

  async function loadHistory() {
    const id = deviceIdInput.value;
    if (!id) return;
    try {
      const res = await fetch(`/pay/api/postmain/proxy/history?deviceId=${id}&pageNum=${pageNum}&pageSize=${pageSize}`);
      const result = await res.json();

      total = result.total || 0;
      const historyList = result.rows || [];

      historyBox.innerHTML = '';
      historyList.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.textContent = `${item.method} ${item.url} (状态: ${item.statusCode}, 时间: ${item.createTime})`;
        div.onclick = () => fillRequest(item);
        historyBox.appendChild(div);
      });

      // 更新分页信息
      const totalPages = Math.ceil(total / pageSize) || 1;
      document.getElementById('pageInfo').textContent = `第 ${pageNum} / ${totalPages} 页`;
      document.getElementById('prevPage').disabled = pageNum <= 1;
      document.getElementById('nextPage').disabled = pageNum >= totalPages;
    } catch {
      historyBox.innerHTML = '<i>无法加载历史记录</i>';
    }
  }

  function changePage(delta) {
    pageNum += delta;
    if (pageNum < 1) pageNum = 1;
    loadHistory();
  }

  function fillRequest(item) {
    urlInput.value = item.url;
    methodSelect.value = item.method;
    headersInput.value = Object.entries(item.headers || {}).map(([k, v]) => `${k}: ${v}`).join("\n");
    bodyInput.value = item.body || "";

    if (item.headers && item.headers["Content-Type"]) {
      contentTypeSelect.value = item.headers["Content-Type"];
    }

    // 📱 自动收起抽屉
    document.querySelector('.history-panel').classList.remove('active');
  }

  function toggleHistory() {
    document.querySelector('.history-panel').classList.toggle('active');
  }
</script>
</body>
</html>
