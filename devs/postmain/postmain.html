<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Postmain Proxy è¯·æ±‚å·¥å…·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f9;
    }

    h2 {
      margin: 0;
      padding: 15px;
      background: #2c3e50;
      color: #fff;
    }

    .container {
      display: flex;
      min-height: calc(100vh - 50px);
    }

    /* ============ å†å²è¯·æ±‚åŒºï¼ˆé»˜è®¤ï¼šæ¡Œé¢å¯è§ï¼‰ ============ */
    .history-panel {
      width: 280px;
      border-right: 2px solid #ddd;
      background: #fff;
      padding: 10px;
      overflow-y: auto;
      box-sizing: border-box;
      /* åœ¨æ¡Œé¢ä¿æŒè‡ªç„¶å¸ƒå±€ï¼ˆdisplay:block é»˜è®¤å³å¯ï¼‰ */
    }

    .history-item {
      cursor: pointer;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .history-item:hover {
      background: #f0f0f0;
    }

    /* åˆ†é¡µæ§ä»¶ */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      gap: 10px;
      font-size: 14px;
    }

    .pagination button {
      padding: 5px 12px;
      border: 1px solid #007bff;
      background: #fff;
      color: #007bff;
      border-radius: 4px;
      cursor: pointer;
      transition: background .15s, color .15s, border-color .15s;
    }
    .pagination button:hover:not(:disabled) {
      background: #007bff;
      color: #fff;
    }
    .pagination button:disabled,
    .pagination button[disabled] {
      background: #f0f0f0;
      color: #aaa;
      border-color: #ccc;
      cursor: not-allowed;
      pointer-events: none;
      opacity: 0.9;
    }
    #pageInfo {
      color: #333;
      font-weight: 600;
      margin: 0 8px;
    }

    /* è¯·æ±‚åŒº */
    .main-panel {
      flex: 1;
      padding: 20px;
      background: #fff;
      border-left: 2px solid #ddd;
      box-sizing: border-box;
    }

    textarea, input, select {
      width: 100%;
      margin: 5px 0;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      margin: 5px 0;
      padding: 6px 12px;
      cursor: pointer;
      border: 1px solid #2c3e50;
      background: #34495e;
      color: #fff;
      border-radius: 4px;
    }

    button.loading {
      cursor: not-allowed;
      opacity: 0.7;
      position: relative;
    }
    button.loading::after {
      content: "";
      position: absolute;
      right: -25px;
      top: 50%;
      width: 16px;
      height: 16px;
      margin-top: -8px;
      border: 2px solid #ccc;
      border-top-color: #333;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    pre {
      background: #f8f8f8;
      padding: 10px;
      border: 1px solid #ddd;
      overflow-x: auto;
    }

    /* ============ æ‰‹æœºç«¯ï¼šç”¨ transform æŠ½å±‰ + é®ç½© ============ */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 900;
      transition: opacity .2s;
    }
    .overlay.active { display: block; }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      /* å°†é¢æ¿å˜æˆå›ºå®šæŠ½å±‰ï¼Œåˆå§‹ç§»å‡ºå±å¹•ï¼ˆå·¦ä¾§ï¼‰ */
      .history-panel {
        position: fixed;
        top: 50px;
        left: 0;
        bottom: 0;
        width: 250px;
        transform: translateX(-100%); /* éšè—ï¼šç§»å‡ºå±å¹• */
        transition: transform .25s ease;
        z-index: 1000;
        display: block; /* ä¿æŒ blockï¼Œé  transform æ§åˆ¶å¯è§æ€§ */
      }

      /* æ‰“å¼€æ—¶æ»‘å…¥ */
      .history-panel.active {
        transform: translateX(0);
      }

      .toggle-history {
        display: block;
        margin: 10px;
      }

      /* åœ¨å°å±å¹•ä¸Šï¼Œä¸ºäº†é¿å…ä¸»å†…å®¹åœ¨æŠ½å±‰æ‰“å¼€æ—¶ä»ç„¶æœ‰å·¦è¾¹ borderï¼Œç§»é™¤ main-panel çš„ left border */
      .main-panel {
        border-left: none;
      }
    }

    @media (min-width: 769px) {
      .toggle-history {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h2>Postmain Proxy è¯·æ±‚å·¥å…·</h2>
  <button class="toggle-history" onclick="toggleHistory()">ğŸ“œ æŸ¥çœ‹å†å²è¯·æ±‚</button>

  <!-- é®ç½©ï¼ˆä»…ç§»åŠ¨ç«¯æ‰“å¼€æ—¶å¯ç”¨ï¼‰ -->
  <div id="overlay" class="overlay" onclick="closeHistory()"></div>

  <div class="container">
    <!-- å†å²è¯·æ±‚ -->
    <div class="history-panel">
      <div id="history"></div>
      <!-- åˆ†é¡µæ§ä»¶ -->
      <div class="pagination">
        <button id="prevPage" disabled onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
        <span id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
        <button id="nextPage" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
      </div>
    </div>

    <!-- è¯·æ±‚å·¥å…· -->
    <div class="main-panel">
      <label>è®¾å¤‡å”¯ä¸€ID:</label>
      <input type="text" id="deviceId" placeholder="è¾“å…¥æˆ–ç”Ÿæˆè®¾å¤‡ID">
      <button onclick="generateDeviceId()">ç”ŸæˆéšæœºID</button>
      <button onclick="handleQuery()">æŸ¥è¯¢</button>
      <br>
      <label>è¯·æ±‚ URL:</label>
      <input type="text" id="url" placeholder="https://example.com/api">

      <label>è¯·æ±‚æ–¹æ³•:</label>
      <select id="method">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
      </select>

      <label>å†…å®¹ç±»å‹(Content-Type):</label>
      <select id="contentType" onchange="setContentType()">
        <option value="application/json">application/json</option>
        <option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option>
        <option value="text/xml">text/xml</option>
        <option value="text/plain">text/plain</option>
      </select>

      <label>è¯·æ±‚å¤´ (æ”¯æŒ JSON æˆ– æ¯è¡Œ `key: value` æ ¼å¼):</label>
      <textarea id="headers" rows="4">Content-Type: application/json</textarea>

      <label>è¯·æ±‚ä½“:</label>
      <textarea id="body" rows="4"></textarea>

      <button id="sendBtn" onclick="sendRequest()">å‘é€è¯·æ±‚</button>

      <h3>å“åº”ç»“æœ</h3>
      <pre id="response"></pre>
    </div>
  </div>

<script>
  const deviceIdInput = document.getElementById('deviceId');
  const urlInput = document.getElementById('url');
  const methodSelect = document.getElementById('method');
  const contentTypeSelect = document.getElementById('contentType');
  const headersInput = document.getElementById('headers');
  const bodyInput = document.getElementById('body');
  const responseBox = document.getElementById('response');
  const historyBox = document.getElementById('history');
  const sendBtn = document.getElementById('sendBtn');

  const panel = document.querySelector('.history-panel');
  const overlay = document.getElementById('overlay');

  // åˆ†é¡µå‚æ•°
  let pageNum = 1;
  const pageSize = 10;
  let total = 0;

  // åˆ¤æ–­æ˜¯å¦ä¸ºæ‰‹æœºç«¯
  function isMobile() {
    return window.innerWidth <= 768 || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  // åˆå§‹åŒ–è®¾å¤‡ID & é¢æ¿é»˜è®¤çŠ¶æ€
  window.addEventListener('DOMContentLoaded', () => {
    const savedId = localStorage.getItem('deviceId');
    if (savedId) deviceIdInput.value = savedId;
    else generateDeviceId();

    // åŠ è½½å†å²ï¼ˆå¼‚æ­¥ï¼‰
    loadHistory();

    // æ ¹æ®å½“å‰å®½åº¦è®¾ç½®é¢æ¿åˆå§‹çŠ¶æ€ï¼š
    if (isMobile()) {
      panel.classList.remove('active'); // éšè—ï¼ˆç§»å‡ºå±å¹•ï¼‰
      overlay.classList.remove('active');
    } else {
      panel.classList.add('active'); // æ¡Œé¢ç«¯è®©å®ƒå¤„äºâ€œå±•å¼€â€çŠ¶æ€ï¼ˆå¸¸æ˜¾ï¼‰
      overlay.classList.remove('active');
    }
  });

  // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–ï¼Œåˆ‡æ¢é»˜è®¤å±•å¼€/æ”¶èµ·ï¼ˆç”¨æˆ·æ”¹æ¨ªç«–å±æ—¶å‹å¥½ï¼‰
  window.addEventListener('resize', () => {
    if (isMobile()) {
      panel.classList.remove('active');
      overlay.classList.remove('active');
    } else {
      panel.classList.add('active');
      overlay.classList.remove('active');
    }
  });

  function openHistory() {
    panel.classList.add('active');
    overlay.classList.add('active');
  }
  function closeHistory() {
    panel.classList.remove('active');
    overlay.classList.remove('active');
  }
  function toggleHistory() {
    // ä»…åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨æŠ½å±‰+é®ç½©ä½“éªŒï¼›æ¡Œé¢ä¸ŠæŒ‰é’®éšè—ä½†ä¹Ÿå®‰å…¨æ— å®³
    if (isMobile()) {
      panel.classList.toggle('active');
      overlay.classList.toggle('active');
    } else {
      // æ¡Œé¢ä¸Šä¸åˆ‡æ¢é®ç½©ï¼Œä¿æŒå¸¸æ˜¾ï¼ˆè‹¥ä½ æƒ³è®©æŒ‰é’®ä¹Ÿèƒ½æ”¶èµ·æ¡Œé¢ï¼Œå¯å¯ç”¨ä¸‹ä¸€è¡Œï¼‰
      // panel.classList.toggle('active');
    }
  }

  function generateDeviceId() {
    const info = [
      navigator.userAgent,
      navigator.language,
      screen.width,
      screen.height,
      screen.colorDepth,
      Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join("###");

    let hash = 0;
    for (let i = 0; i < info.length; i++) {
      hash = (hash << 5) - hash + info.charCodeAt(i);
      hash |= 0;
    }
    const devId = "dev-" + Math.abs(hash);
    deviceIdInput.value = devId;
    localStorage.setItem('deviceId', devId);
    return devId;
  }

  function parseHeaders(text) {
    let headers = {};
    try {
      headers = JSON.parse(text);
    } catch {
      const lines = text.split("\n");
      lines.forEach(line => {
        const [key, ...rest] = line.split(":");
        if (key && rest.length) {
          headers[key.trim()] = rest.join(":").trim();
        }
      });
    }
    return headers;
  }

  function setContentType() {
    let headers = parseHeaders(headersInput.value);
    headers["Content-Type"] = contentTypeSelect.value;
    headersInput.value = Object.entries(headers).map(([k, v]) => `${k}: ${v}`).join("\n");
  }

  async function sendRequest() {
    const headers = parseHeaders(headersInput.value || "");
    const payload = {
      deviceId: deviceIdInput.value,
      url: urlInput.value,
      method: methodSelect.value,
      headers,
      body: bodyInput.value
    };

    sendBtn.classList.add("loading");
    sendBtn.disabled = true;

    try {
      const res = await fetch('/pay/api/postmain/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      const data = result.data || {};
      let bodyText = data.body;
      try {
        bodyText = JSON.stringify(JSON.parse(data.body), null, 2);
      } catch {}

      responseBox.innerHTML = `
        <div>
          <p><strong>Status:</strong> ${data.statusCodeValue || '-'} (${data.statusCode || '-'})</p>
          <p><strong>Body:</strong></p>
          <pre>${bodyText || ''}</pre>
        </div>
      `;
      loadHistory();
    } catch (err) {
      responseBox.textContent = 'è¯·æ±‚é”™è¯¯: ' + err;
    } finally {
      sendBtn.classList.remove("loading");
      sendBtn.disabled = false;
    }
  }

  function handleQuery() {
    loadHistory()
  }

  async function loadHistory() {
    const id = deviceIdInput.value;
    if (!id) return;
    try {
      const res = await fetch(`/pay/api/postmain/proxy/history?deviceId=${id}&pageNum=${pageNum}&pageSize=${pageSize}`);
      const result = await res.json();

      total = result.total || 0;
      const historyList = result.rows || [];

      historyBox.innerHTML = '';
      historyList.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.textContent = `${item.method} ${item.url} (çŠ¶æ€: ${item.statusCode}, æ—¶é—´: ${item.createTime})`;
        div.onclick = () => fillRequest(item);
        historyBox.appendChild(div);
      });

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      const totalPages = Math.ceil(total / pageSize) || 1;
      document.getElementById('pageInfo').textContent = `ç¬¬ ${pageNum} / ${totalPages} é¡µ`;
      document.getElementById('prevPage').disabled = pageNum <= 1;
      document.getElementById('nextPage').disabled = pageNum >= totalPages;
    } catch {
      historyBox.innerHTML = '<i>æ— æ³•åŠ è½½å†å²è®°å½•</i>';
    }
  }

  function changePage(delta) {
    pageNum += delta;
    if (pageNum < 1) pageNum = 1;
    loadHistory();
  }

  function fillRequest(item) {
    urlInput.value = item.url;
    methodSelect.value = item.method;
    headersInput.value = Object.entries(item.headers || {}).map(([k, v]) => `${k}: ${v}`).join("\n");
    bodyInput.value = item.body || "";

    if (item.headers && item.headers["Content-Type"]) {
      contentTypeSelect.value = item.headers["Content-Type"];
    }

    // æ‰‹æœºç«¯é€‰æ‹©è®°å½•åè‡ªåŠ¨æ”¶èµ·
    if (isMobile()) closeHistory();
  }
</script>
</body>
</html>
