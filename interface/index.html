<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>API文档中心</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }

    .header {
      background: #4CAF50;
      color: white;
      padding: 10px 15px;
      font-size: 18px;
      font-weight: bold;
    }

    .container {
      display: flex;
      height: calc(100vh - 50px);
    }

    /* 左侧目录 */
    .sidebar {
      width: 250px;
      background: #f4f4f4;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    .sidebar.hidden {
      transform: translateX(-100%);
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar li {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .sidebar li:hover {
      background: #e0e0e0;
    }
    .sidebar .group {
      font-weight: bold;
      background: #ddd;
    }

    /* 右侧内容 */
    .content {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    h2 { margin-top: 0; }

    .api-info {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .api-info p {
      margin: 5px 0;
    }

    .params, .headers {
      margin-bottom: 10px;
    }

    .params input, .headers input {
      width: 100%;
      padding: 6px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #45a049;
    }

    .result {
      white-space: pre-wrap;
      background: #1e1e1e;
      color: #dcdcdc;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      margin-top: 10px;
    }

    /* 手机端样式 */
    .toggle-btn {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      z-index: 1000;
      cursor: pointer;
    }
  /* ====== 样式：放到你的 <style> ====== */
  .help-wrapper {
    position: relative;
    display: inline-block;
    margin-left: 6px;
    vertical-align: middle;
    font-size: 12px;
  }

  /* 行内显示的简短说明（单行） */
  .help-inline {
    color: #666;
    font-size: 12px;
    margin-left: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60vw; /* 防止超出屏幕 */
  }

  /* 圆形问号图标 */
  .help-icon {
    display: inline-block;
    width: 18px;
    height: 18px;
    line-height: 18px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    color: #fff;
    background-color: #007acc;
    border-radius: 50%;
    cursor: pointer;
    user-select: none;
    margin-left: 6px;
    position: relative;
  }

  /* tooltip 气泡（默认单行显示、省略） */
  .help-tooltip {
    display: none; /* 初始隐藏，通过 JS 控制显示 */
    position: absolute;
    top: 26px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    background: rgba(0,0,0,0.88);
    color: #fff;
    padding: 8px 10px;
    border-radius: 6px;
    font-size: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);

    /* 强制横行显示（解决竖排问题） */
    writing-mode: horizontal-tb !important;
    unicode-bidi: isolate-override !important;

    /* 默认单行且省略显示 */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: min(380px, calc(100vw - 40px));
  }

  /* 展开后的 tooltip（多行） */
  .help-tooltip.expanded {
    white-space: normal;
    overflow-wrap: break-word;
    text-overflow: clip;
    max-width: min(680px, calc(100vw - 40px));
  }

  /* 小箭头（可选） */
  .help-tooltip::after {
    content: "";
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: transparent transparent rgba(0,0,0,0.88) transparent;
  }


    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 50px; left: 0; bottom: 0;
        z-index: 999;
      }
      .toggle-btn {
        display: block;
      }
      .content {
        padding-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header" id="projectTitle">API文档中心</div>
  <div class="toggle-btn" onclick="toggleSidebar()">目录</div>

  <div class="container">
    <div class="sidebar" id="sidebar">
      <ul id="directoryList"></ul>
    </div>
    <div class="content">
      <h2 id="apiName">请选择接口</h2>
      <div class="api-info" id="apiDetail">
        <p><strong>请求方式:</strong> <span id="method">-</span></p>
        <p><strong>请求地址:</strong> <span id="url">-</span></p>
        <div class="headers">
          <h4>请求头</h4>
          <div id="headers"></div>
        </div>
        <div class="params">
          <h4>请求参数</h4>
          <div id="params"></div>
        </div>
        <div class="response">
            <h4>返回结果</h4>
            <div id="responseContent"></div>
        </div>
        <button onclick="sendRequest()">调试</button>
        <div class="result" id="resultArea">
          <div id="statusButtons"></div>
          <pre id="bodyResult"></pre>
        </div>

      </div>
    </div>
  </div>

  <script>
  const sidebar = document.getElementById("sidebar");
  const directoryList = document.getElementById("directoryList");
  let currentApi = null;

  function toggleSidebar() {
    sidebar.classList.toggle("hidden");
  }

  // 获取 URL 参数
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  async function loadDirectory() {
    try {
      const pid = getQueryParam("pid") || 0; // 默认0
      let res = await fetch("/pay/api/interface/list?pid=" + pid, { method: "POST" });
      let data = await res.json();
      if (data.code === 0 || data.code === 200) {
        const projectName = data.data.project?.name || "未命名项目";
        document.getElementById("projectTitle").textContent = "API文档中心 - " + projectName;
        document.title = "API文档中心 - " + projectName;
        renderDirectory(data.data.list || []);
      } else {
        directoryList.innerHTML = "<li>加载失败: " + data.msg + "</li>";
      }
    } catch (e) {
      console.error("加载目录失败", e);
      directoryList.innerHTML = "<li>加载失败: " + e + "</li>";
    }
  }

  /* ====== JS：渲染时使用的辅助函数（集成到 renderInputs 中） ====== */

  /**
   * 在 wrapper（当前字段容器）中创建帮助节点
   * detailText: 要显示的完整说明文本（字符串）
   * wrapper: 当前字段的 DOM 元素（label+input 父容器）
   */
  function appendHelpNode(detailText, wrapper) {
    const helpWrapper = document.createElement('span');
    helpWrapper.className = 'help-wrapper';

    // 先测量文字实际宽度（单行）
    const temp = document.createElement('span');
    temp.style.position = 'absolute';
    temp.style.visibility = 'hidden';
    temp.style.whiteSpace = 'nowrap';
    temp.style.fontSize = window.getComputedStyle(wrapper).fontSize || '12px';
    temp.textContent = detailText;
    document.body.appendChild(temp);
    const textWidth = temp.getBoundingClientRect().width;
    temp.remove();

    // 计算容器右侧可用空间（到 params 区域右边界）
    const paramsContainer = document.getElementById('params') || document.querySelector('.content');
    const wrapperRect = wrapper.getBoundingClientRect();
    const containerRect = paramsContainer.getBoundingClientRect();
    const availableRight = containerRect.right - wrapperRect.right - 8; // 留点间隙

    if (textWidth <= availableRight) {
      // 空间够：直接行内显示（单行）
      const span = document.createElement('span');
      span.className = 'help-inline';
      span.textContent = detailText;
      helpWrapper.appendChild(span);
      wrapper.appendChild(helpWrapper);
      return;
    }

    // 空间不够：显示问号图标，点击展开 tooltip
    const icon = document.createElement('span');
    icon.className = 'help-icon';
    icon.textContent = '?';

    const tooltip = document.createElement('div');
    tooltip.className = 'help-tooltip';
    tooltip.innerHTML = detailText; // 可以包含 <b>、<code> 等 HTML

    // 点击图标：切换展开 / 收起
    icon.addEventListener('click', function (e) {
      e.stopPropagation();
      const isShown = tooltip.style.display === 'block';
      // 先隐藏其它 open tooltip
      document.querySelectorAll('.help-tooltip.expanded, .help-tooltip').forEach(el => {
        if (el !== tooltip) { el.style.display = 'none'; el.classList.remove('expanded'); }
      });
      if (!isShown) {
        tooltip.style.display = 'block';
        // 如果内容超出单行则添加 expanded 让其多行显示
        if (tooltip.scrollWidth > tooltip.clientWidth) {
          tooltip.classList.add('expanded');
        } else {
          tooltip.classList.remove('expanded');
        }
      } else {
        tooltip.style.display = 'none';
        tooltip.classList.remove('expanded');
      }
    });

    // 点击页面任意地方收起
    document.addEventListener('click', () => {
      tooltip.style.display = 'none';
      tooltip.classList.remove('expanded');
    });

    helpWrapper.appendChild(icon);
    helpWrapper.appendChild(tooltip);
    wrapper.appendChild(helpWrapper);
  }


  function renderDirectory(list) {
    directoryList.innerHTML = "";

    list.forEach(group => {
      let groupLi = document.createElement("li");
      groupLi.textContent = group.name;
      groupLi.classList.add("group");
      directoryList.appendChild(groupLi);

      if (group.subList && group.subList.length > 0) {
        let ul = document.createElement("ul");
        ul.style.marginLeft = "15px";

        group.subList.forEach(api => {
          let apiLi = document.createElement("li");
          apiLi.textContent = api.name;
          apiLi.onclick = () => renderApiDetail(api);
          ul.appendChild(apiLi);
        });

        directoryList.appendChild(ul);
      }
    });
  }

  function initSidebar() {
    if (window.innerWidth > 768) {
        sidebar.classList.remove("hidden"); // PC端默认展开
    }
  }
// 当前API的 remarkMap
let currentRemarkMap = {};

// 渲染输入框（记录路径为数组）
function renderInputs(container, obj, path = []) {
  Object.keys(obj).forEach(key => {
    let value = obj[key];
    let newPath = [...path, key]; // 记录层级路径数组

    if (typeof value === "object" && value !== null) {
      // 折叠节点
      let section = document.createElement("div");
      section.style.margin = "6px 0";

      let toggle = document.createElement("div");
      toggle.textContent = key + " ⯆";
      toggle.style.cursor = "pointer";
      toggle.style.fontWeight = "bold";
      toggle.style.color = "#007acc";

      let subContainer = document.createElement("div");
      subContainer.style.marginLeft = "16px";

      renderInputs(subContainer, value, newPath);

      toggle.onclick = () => {
        if (subContainer.style.display === "none") {
          subContainer.style.display = "block";
          toggle.textContent = key + " ⯆";
        } else {
          subContainer.style.display = "none";
          toggle.textContent = key + " ⯈";
        }
      };

      section.appendChild(toggle);
      section.appendChild(subContainer);
      container.appendChild(section);
    } else {
      // 普通输入框
      let wrapper = document.createElement("div");
      wrapper.style.marginBottom = "6px";

      let label = document.createElement("span");
      label.textContent = key + ": ";
      label.style.marginRight = "6px";

      let input = document.createElement("input");
      input.value = value || "";
      input.dataset.path = JSON.stringify(newPath); // 保存层级路径数组

      wrapper.appendChild(label);

      if (currentRemarkMap[key]) {
        let info = currentRemarkMap[key];
        let helpWrapper = document.createElement("span");
        helpWrapper.className = "help-wrapper";

        // 详细说明文字
        let detailText =
          (info.required == 1 ? "[必填] " : "[可选] ") +
          (info.type ? "(" + info.type + ") " : "") +
          (info.remark ? info.remark + " " : "") +
          (info.example ? "示例: " + info.example : "");
        appendHelpNode(detailText.trim(), wrapper);
      }


      wrapper.appendChild(input);
      container.appendChild(wrapper);
    }
  });
}


// 点击调试时，把所有 input 值还原成对象
function collectInputs(container) {
  let inputs = container.querySelectorAll("input");
  let result = {};

  inputs.forEach(input => {
    let path = JSON.parse(input.dataset.path); // 取回路径数组
    let val = input.value;

    // 自动尝试转数字/布尔/json
    try {
      val = JSON.parse(val);
    } catch {
      // 不是 JSON 就当字符串
    }

    // 按路径写入对象
    let target = result;
    for (let i = 0; i < path.length - 1; i++) {
      let key = path[i];
      if (!target[key]) target[key] = {};
      target = target[key];
    }
    target[path[path.length - 1]] = val;
  });

  return result;
}


// 点击目录时调用
function renderApiDetail(api) {
  currentApi = api;

  document.getElementById("apiName").textContent = api.name || "未命名接口";
  document.getElementById("method").textContent = api.method || "-";
  document.getElementById("url").textContent = api.url || "-";

  const headersDiv = document.getElementById("headers");
  const paramsDiv = document.getElementById("params");
  headersDiv.innerHTML = "";
  paramsDiv.innerHTML = "";

  // ✅ 直接取 subList 里的 remarkMap
  currentRemarkMap = api.remarkMap || {};

  // 渲染 headers
  try {
    let headersObj = {};
    if (api.headers) {
      headersObj = typeof api.headers === "string" ? JSON.parse(api.headers) : api.headers;
    }
    renderInputs(headersDiv, headersObj);
  } catch (e) {
    console.warn("解析 headers 出错", e);
    headersDiv.innerHTML = "<p>"+api.headers+"</p>";
  }

  // 渲染 parameter
  try {
    let paramsObj = {};
    if (api.parameter) {
      paramsObj = typeof api.parameter === "string" ? JSON.parse(api.parameter) : api.parameter;
    }
    renderInputs(paramsDiv, paramsObj);
  } catch (e) {
    console.warn("解析 parameter 出错", e);
    paramsDiv.innerHTML = "<p>"+api.parameter+"</p>";
  }

  // 渲染 response
    let responseDiv = document.getElementById("response");
    if (!responseDiv) {
      responseDiv = document.createElement("div");
      responseDiv.className = "response";
      responseDiv.innerHTML = "<h4>返回结果</h4><div id='responseContent'></div>";
      document.getElementById("apiDetail").appendChild(responseDiv);
    }

    const responseContent = document.getElementById("responseContent");
    responseContent.innerHTML = "";

    if (api.response) {
      try {
        let responseObj = typeof api.response === "string" ? JSON.parse(api.response) : api.response;
        responseContent.innerHTML = "<pre>" + JSON.stringify(responseObj, null, 2) + "</pre>";
      } catch (e) {
        responseContent.innerHTML = "<pre>" + api.response + "</pre>";
      }
    } else {
      responseContent.innerHTML = "<pre>无返回信息</pre>";
    }

  
  // 手机端自动收起目录
  if (window.innerWidth <= 768) {
    sidebar.classList.add("hidden");
  }
}

  function generateDeviceId() {
    const info = [
      navigator.userAgent,
      navigator.language,
      screen.width,
      screen.height,
      screen.colorDepth,
      Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join("###");

    let hash = 0;
    for (let i = 0; i < info.length; i++) {
      hash = (hash << 5) - hash + info.charCodeAt(i);
      hash |= 0;
    }
    const devId = "dev-" + Math.abs(hash);
    localStorage.setItem('deviceId', devId);
    return devId;
  }

  async function sendRequest() {
    if (!currentApi) return alert("请先选择接口");

    const headersObj = collectInputs(document.getElementById("headers"));
    const paramsObj = collectInputs(document.getElementById("params"));
    const deviceId = generateDeviceId();

    const payload = {
      deviceId: deviceId,
      url: currentApi.url,
      method: currentApi.method.toUpperCase(),
      headers: headersObj,
      body: JSON.stringify(paramsObj)
    };

    try {
      let res = await fetch("/pay/api/postmain/proxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      let result = await res.json();

      const statusButtons = document.getElementById("statusButtons");
      const bodyResult = document.getElementById("bodyResult");
      statusButtons.innerHTML = "";
      bodyResult.textContent = "";

      if (result.code === 0 && result.data) {
        const data = result.data;

        // 显示 statusCode 和 statusCodeValue
        ["statusCode", "statusCodeValue"].forEach(key => {
          let btn = document.createElement("button");
          btn.textContent = key + ": " + data[key];
          btn.style.marginRight = "8px";
          statusButtons.appendChild(btn);
        });

        // 解析 body
        try {
          let parsed = JSON.parse(data.body);
          bodyResult.textContent = JSON.stringify(parsed, null, 2);
        } catch {
          bodyResult.textContent = data.body || "";
        }
      } else {
        bodyResult.textContent = "错误: " + (result.msg || "未知错误");
      }
    } catch (e) {
      document.getElementById("resultArea").textContent = "请求失败: " + e;
    }
  }

  // 初始化
  loadDirectory();
  initSidebar();
</script>


</body>
</html>
